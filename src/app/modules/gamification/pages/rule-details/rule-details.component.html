<div fxLayout="column" style="min-height: 100%">
  <div fxLayout="row" style="width: 100%; min-height: 64px;" class="padding-16 border-bottom-gray">
    <div class="page-title" fxLayout="row wrap" fxLayoutAlign="start center">
      {{'gamificationRuleScreen.title' | translate}}
    </div>
  </div>
  <form [formGroup]="ruleForm">
    <div fxLayout="row wrap"
      class="padding-left-16 padding-right-16 padding-top-10 padding-bottom-10 border-bottom-gray">
      <div fxFlex="50%" fxLayout="row wrap" fxLayoutGap="10px">
        <div fxFlexAlign="center" class="font-gotham-bold font-sub-description">
          {{'gamificationRuleScreen.sampleSize' | translate}} :
        </div>
        <div fxFlex="150px">
          <app-masked-num-input formControlName="sampleSize" (change)="calculateRule()" (keyup)="calculateRule()">
          </app-masked-num-input>
          <mat-error class="bottom-error" *ngIf="sampleSize.invalid && (sampleSize.dirty || sampleSize.touched)">
            <span *ngIf="sampleSize.errors.required">{{'forms.sampleSize.errorRequired' | translate}}</span>
            <span *ngIf="sampleSize.errors.pattern">{{'forms.sampleSize.errorFormat' | translate }}</span>
            <span
              *ngIf="!sampleSize.errors.pattern && sampleSize.errors.min">{{'forms.sampleSize.errorMin' | translate : sampleSearchValidation}}</span>
          </mat-error>
        </div>
      </div>
      <div fxFlex="50%" fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="10px">
        <button mat-raised-button color="accent" *ngIf="!onSubmittingForm" [disabled]="loading"
          (click)="goToListScreen()">{{'cancel' | translate}}</button>
        <button mat-raised-button color="primary" *ngIf="!onSubmittingForm" [disabled]="loading || ruleForm.invalid"
          (click)="save()">{{'save' | translate}}</button>
        <button mat-raised-button color="primary" disabled *ngIf="onSubmittingForm">
          <div fxLayout="row" fxLayoutAlign="center center">
            <div>
              <mat-spinner diameter="16"></mat-spinner>
            </div>
            <div class="margin-left-5">{{'loading' | translate}}</div>
          </div>
        </button>
      </div>
    </div>
    <div class="border-bottom-gray" fxLayout="row wrap" fxLayoutAlign="start center" style="overflow-x: auto">
      <table mat-table [dataSource]="rule.controls" class="table-min-100" #ruleTable formArrayName="rule">
        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef class="font-th th-width-25"> {{'table.numbers' | translate}} </th>
          <td mat-cell *matCellDef="let element; let i = index">
            {{ i + 1}}
          </td>
        </ng-container>
        <ng-container matColumnDef="reward">
          <th mat-header-cell *matHeaderCellDef class="font-th th-min-width-150 th-width-150">
            {{'table.gamificationTable.reward' | translate}}
          </th>
          <td mat-cell *matCellDef="let element; let i = index">
            <div [formGroupName]="i" class="padding-top-5 padding-bottom-5">
              <app-masked-num-input formControlName="reward" [type]="inputMaskType.percentage"
                (change)="calculateRule()" (keyup)="calculateRule()">
              </app-masked-num-input>
              <mat-error class="bottom-error text-left"
                *ngIf="getReward(element).invalid && (getReward(element).dirty || getReward(element).touched)">
                <span *ngIf="getReward(element).errors.required">{{'forms.reward.errorRequired' | translate}}</span>
                <span *ngIf="getReward(element).errors.min">{{'forms.reward.errorMin' | translate}}</span>
              </mat-error>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="probability">
          <th mat-header-cell *matHeaderCellDef class="font-th th-min-width-150 th-width-150">
            {{'table.gamificationTable.probability' | translate}}
          </th>
          <td mat-cell *matCellDef="let element; let i = index" [class.text-right]="i === rule.controls.length - 1">
            <div *ngIf="i < rule.controls.length - 1; else lastRow" [formGroupName]="i"
              class="padding-top-5 padding-bottom-5">
              <app-masked-num-input formControlName="probability" [type]="inputMaskType.percentage"
                (change)="calculateRule()" (keyup)="calculateRule()">
              </app-masked-num-input>
              <mat-error class="bottom-error text-left"
                *ngIf="getProbability(element).invalid && (getProbability(element).dirty || getProbability(element).touched)">
                <span
                  *ngIf="getProbability(element).errors.required">{{'forms.probability.errorRequired' | translate}}</span>
                <span *ngIf="getProbability(element).errors.min">{{'forms.probability.errorMin' | translate}}</span>
              </mat-error>
            </div>
            <ng-template #lastRow>
              <div>
                {{getProbability(element).value !== null ? (getProbability(element).value | percent: '1.0-4' : locale) : ''}}
              </div>
              <mat-error class="bottom-error text-left" *ngIf="getProbability(element).invalid">
                <span *ngIf="getProbability(element).errors.min">{{'forms.probability.errorMin' | translate}}</span>
              </mat-error>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="blended">
          <th mat-header-cell *matHeaderCellDef class="font-th th-min-width-150 th-width-150">
            {{'table.gamificationTable.blended' | translate}}
          </th>
          <td mat-cell *matCellDef="let element" class="text-right">
            {{getBlended(element).value !== null ? (getBlended(element).value | percent: '1.0-4' : locale) : ''}}
          </td>
        </ng-container>

        <ng-container matColumnDef="totalPerson">
          <th mat-header-cell *matHeaderCellDef class="font-th th-min-width-150 th-width-150">
            <div>{{'table.gamificationTable.totalPerson' | translate}}</div>
            <div class="font-roboto font-tag">{{'gamificationRuleScreen.totalPersonFormula' | translate}}</div>
          </th>
          <td mat-cell *matCellDef="let element" class="text-right">
            {{getTotalPerson(element).value !== null ? (getTotalPerson(element).value | number: '' : locale) : ''}}
          </td>
        </ng-container>

        <ng-container matColumnDef="disclaimer">
          <th mat-header-cell *matHeaderCellDef class="th-width-250 th-min-width-200">
          </th>
          <td mat-cell *matCellDef="let element; let i = index">
            <div style="width: 100%" class="padding-top-5 padding-bottom-5" *ngIf="i === rule.controls.length - 1">
              <div fxLayout="row" class="bg-light-gray padding-5" fxLayoutAlign="start center">
                <div class="padding-left-5 padding-right-5">
                  <mat-icon>information</mat-icon>
                </div>
                <div fxFlex="grow" class="font-tag">
                  {{'gamificationRuleScreen.lastRowDisclaimer' | translate}}
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="empty">
          <th mat-header-cell *matHeaderCellDef class="th-min-width-50">
          </th>
          <td mat-cell *matCellDef="let element">
          </td>
        </ng-container>

        <tr class="bg-light-gray" mat-header-row *matHeaderRowDef="ruleColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: ruleColumns" [hidden]="loading"></tr>
      </table>
    </div>
  </form>
  <div fxFlex="grow" style="min-height:100px" fxLayout="row wrap" fxLayoutAlign="center center" *ngIf="loading">
    <div fxLayout="row" fxFlex="100%" fxLayoutAlign="center center">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
    <div fxLayout="row" fxFlex="100%" fxLayoutAlign="center center" class="margin-top-10 font-title">
      {{'loading' | translate}}...
    </div>
  </div>
</div>